{% extends "sitepublico/base_publico.html" %}
{% load static %}

{% block title %}{{ carro.nome }} {{ carro.ano }} — R$ {{ carro.preco|floatformat:0 }} | CarBusiness{% endblock %}

{% block meta_description %}{{ carro.nome }} {{ carro.ano }} - {{ carro.marca.nome }} - {{ carro.combustivel }} - {{ carro.cambio }} - {{ carro.portas }} portas - {{ carro.km|floatformat:0 }} km. Preço: R$ {{ carro.preco|floatformat:0 }}. Veja todas as fotos e informações completas na CarBusiness.{% endblock %}

{% block og_type %}product{% endblock %}
{% block og_title %}{{ carro.nome }} {{ carro.ano }} — R$ {{ carro.preco|floatformat:0 }}{% endblock %}
{% block og_description %}{{ carro.nome }} {{ carro.ano }} - {{ carro.marca.nome }} - {{ carro.combustivel }} - {{ carro.cambio }} - R$ {{ carro.preco|floatformat:0 }}{% endblock %}
{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{{ carro.foto_principal.url }}{% endblock %}

{% block twitter_title %}{{ carro.nome }} {{ carro.ano }} — R$ {{ carro.preco|floatformat:0 }}{% endblock %}
{% block twitter_description %}{{ carro.nome }} {{ carro.ano }} - {{ carro.marca.nome }} - R$ {{ carro.preco|floatformat:0 }}{% endblock %}
{% block twitter_image %}{{ request.scheme }}://{{ request.get_host }}{{ carro.foto_principal.url }}{% endblock %}

{% block head %}
<!-- Structured Data (JSON-LD) para Carro -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Vehicle",
  "name": "{{ carro.nome }}",
  "brand": {
    "@type": "Brand",
    "name": "{{ carro.marca.nome }}"
  },
  "model": "{{ carro.modelo.nome|default:carro.nome }}",
  "productionDate": "{{ carro.ano }}",
  "mileageFromOdometer": {
    "@type": "QuantitativeValue",
    "value": {{ carro.km }},
    "unitCode": "KMT"
  },
  "vehicleIdentificationNumber": "{{ carro.id }}",
  "color": "{{ carro.cor }}",
  "numberOfDoors": {{ carro.portas }},
  "fuelType": "{{ carro.get_combustivel_display }}",
  "offers": {
    "@type": "Offer",
    "price": "{{ carro.preco }}",
    "priceCurrency": "BRL",
    "availability": "https://schema.org/InStock",
    "seller": {
      "@type": "AutoDealer",
      "name": "{{ carro.loja.nome }}",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "{{ carro.loja.cidade.nome }}",
        "addressRegion": "{{ carro.loja.cidade.estado|default:'' }}",
        "addressCountry": "BR"
      }
    }
  },
  "image": "{{ request.scheme }}://{{ request.get_host }}{{ carro.foto_principal.url }}",
  "description": "{{ carro.descricao|default:carro.nome|truncatewords:30 }}"
}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
    body {
        background: #f8f9fa;
    }

    /* ========== HERO SECTION ========== */
    .hero-section {
        background: linear-gradient(135deg, #D7242A 0%, #B71C1C 100%);
        padding: 40px 20px;
        text-align: center;
        color: white;
        margin-bottom: 40px;
    }

    .hero-section h1 {
        font-size: 32px;
        font-weight: 900;
        margin: 0 0 8px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .hero-section p {
        font-size: 16px;
        margin: 0;
        opacity: 0.95;
    }

    /* ========== CONTAINER ========== */
    .container-carro {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px 60px;
    }

    /* ========== LAYOUT PRINCIPAL ========== */
    .carro-layout {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
    }

    /* ========== GALERIA ========== */
    .galeria-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e8e8e8;
        overflow: hidden;
        position: relative;
    }

    .foto-principal-wrapper {
        position: relative;
        width: 100%;
        height: 500px;
        overflow: hidden;
        background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
    }

    .foto-principal {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }

    .btn-fav {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        transition: all 0.3s;
        z-index: 10;
    }

    .btn-fav:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-fav img {
        width: 28px;
        height: 28px;
    }

    .miniaturas {
        display: flex;
        gap: 10px;
        padding: 20px;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
    }

    .miniaturas::-webkit-scrollbar {
        height: 6px;
    }

    .miniaturas::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .miniaturas img {
        flex-shrink: 0;
        width: 100px;
        height: 75px;
        border-radius: 10px;
        object-fit: cover;
        cursor: pointer;
        transition: all 0.3s;
        border: 3px solid transparent;
    }

    .miniaturas img:hover,
    .miniaturas img.active {
        border-color: #D7242A;
        transform: scale(1.05);
    }

    /* ========== INFO LATERAL ========== */
    .info-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e8e8e8;
        padding: 28px;
    }

    .carro-title {
        font-size: 28px;
        font-weight: 900;
        color: #1C1C1E;
        margin: 0 0 12px;
        line-height: 1.3;
    }

    .carro-subtitle {
        font-size: 16px;
        color: #6E6E73;
        margin: 0 0 24px;
        line-height: 1.5;
    }

    .preco {
        font-size: 38px;
        font-weight: 900;
        color: #D7242A;
        margin: 24px 0;
        line-height: 1;
    }

    .btn-whats {
        width: 100%;
        max-width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #25D366 0%, #1eb65b 100%);
        color: white;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        text-decoration: none;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        margin-top: 24px;
        border: none;
        cursor: pointer;
        box-sizing: border-box;
    }

    .btn-whats:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .btn-whats svg {
        width: 18px;
        height: 18px;
    }

    /* ========== CARD DA LOJA ========== */
    .loja-card {
        margin-top: 24px;
        padding: 18px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e8e8e8;
    }

    .loja-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
    }

    .loja-logo {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        object-fit: cover;
        border: 2px solid #e8e8e8;
        background: white;
        flex-shrink: 0;
    }

    .loja-name {
        font-size: 16px;
        font-weight: 800;
        color: #1C1C1E;
        margin: 0;
        line-height: 1.3;
    }

    .loja-info-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .info-line {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 13px;
        color: #6E6E73;
        line-height: 1.4;
    }

    .info-line svg {
        width: 16px;
        height: 16px;
        color: #D7242A;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .info-line a {
        color: #0066ff;
        text-decoration: none;
        transition: color 0.2s;
    }

    .info-line a:hover {
        color: #0052cc;
        text-decoration: underline;
    }

    /* ========== FICHA TÉCNICA ========== */
    .ficha-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e8e8e8;
        padding: 32px;
        margin-top: 40px;
    }

    .ficha-title {
        font-size: 24px;
        font-weight: 900;
        color: #1C1C1E;
        margin: 0 0 24px;
    }

    .ficha-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
    }

    .ficha-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e8e8e8;
    }

    .ficha-item span {
        font-size: 13px;
        color: #6E6E73;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .ficha-item strong {
        font-size: 20px;
        font-weight: 800;
        color: #1C1C1E;
    }

    /* ========== RESPONSIVIDADE ========== */
    @media (max-width: 992px) {
        .carro-layout {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .info-card {
            position: relative;
        }

        .foto-principal-wrapper {
            height: 400px;
        }
    }

    @media (max-width: 768px) {
        .hero-section {
            padding: 30px 20px;
            margin-bottom: 30px;
        }

        .hero-section h1 {
            font-size: 26px;
        }

        .container-carro {
            padding: 0 15px 40px;
        }

        .foto-principal-wrapper {
            height: 350px;
        }

        .info-card {
            padding: 24px;
        }

        .carro-title {
            font-size: 24px;
        }

        .preco {
            font-size: 32px;
        }

        .ficha-section {
            padding: 24px;
        }

        .ficha-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .btn-fav {
            width: 44px;
            height: 44px;
            top: 15px;
            right: 15px;
        }
    }

    @media (max-width: 480px) {
        .hero-section h1 {
            font-size: 22px;
        }

        .foto-principal-wrapper {
            height: 280px;
        }

        .info-card {
            padding: 20px;
        }

        .carro-title {
            font-size: 20px;
        }

        .preco {
            font-size: 28px;
        }

        .ficha-grid {
            grid-template-columns: 1fr;
        }

        .miniaturas img {
            width: 80px;
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- BREADCRUMB -->
<nav class="breadcrumb" style="margin-bottom: 20px;">
    <a href="{% url 'home' %}">Início</a> &raquo;
    <a href="{% url 'listar_carros' %}">Carros</a> &raquo;
    <span>{{ carro.nome }}</span>
</nav>

<!-- HERO SECTION -->
<div class="hero-section">
    <h1>{{ carro.nome }}</h1>
    <p>{{ carro.marca.nome }} • {{ carro.ano }}</p>
</div>

<div class="container-carro">
    <!-- LAYOUT PRINCIPAL -->
    <div class="carro-layout">
        <!-- GALERIA -->
        <div class="galeria-card">
            <div class="foto-principal-wrapper">
                {% if request.user.is_authenticated %}
                <button class="btn-fav" id="btnFavorito" data-id="{{ carro.id }}"
                    data-favorito="{% if carro.is_favorito %}1{% else %}0{% endif %}">
                    <img id="imgFavorito"
                        src="{% if carro.is_favorito %}{% static 'img/heart.svg' %}{% else %}{% static 'img/heart-outline.svg' %}{% endif %}">
                </button>
                {% endif %}

                {% if carro.foto_principal %}
                <img id="fotoPrincipal" class="foto-principal" src="{{ carro.foto_principal.url }}" alt="{{ carro.nome }} {{ carro.ano }} - {{ carro.marca.nome }}" loading="lazy">
                {% else %}
                <img id="fotoPrincipal" class="foto-principal" src="https://via.placeholder.com/800x500?text=Sem+Imagem" alt="{{ carro.nome }} {{ carro.ano }} - {{ carro.marca.nome }}" loading="lazy">
                {% endif %}
            </div>

            <div class="miniaturas">
                {% if carro.foto_principal %}
                <img src="{{ carro.foto_principal.url }}" class="thumb active">
                {% endif %}

                {% for foto in fotos_extras %}
                <img src="{{ foto.imagem.url }}" class="thumb">
                {% endfor %}

                {% if not carro.foto_principal and not fotos_extras %}
                <p style="padding: 20px; color: #999; text-align: center; width: 100%;">Nenhuma foto disponível</p>
                {% endif %}
            </div>
        </div>

        <!-- INFO LATERAL -->
        <div class="info-card">
            <h2 class="carro-title">{{ carro.nome }}</h2>

            <p class="carro-subtitle">
                {{ carro.marca.nome }} • {{ carro.modelo.nome }}
                {% if carro.versao %} • {{ carro.versao.nome }}{% endif %}
            </p>

            <div class="preco">R$ {{ carro.preco }}</div>

            <!-- WhatsApp -->
            <a class="btn-whats"
                href="https://wa.me/55{{ carro.loja.telefone|cut:'('|cut:')'|cut:'-'|cut:' ' }}?text=Olá! Tenho interesse no veículo {{ carro.nome }}"
                target="_blank">
                <i data-lucide="message-circle"></i>
                Falar com a loja
            </a>

            <!-- LOJA -->
            <div class="loja-card">
                <div class="loja-header">
                    {% if carro.loja.logo %}
                    <img src="{{ carro.loja.logo.url }}" alt="{{ carro.loja.nome }}" class="loja-logo">
                    {% else %}
                    <div class="loja-logo" style="background: #e8e8e8;"></div>
                    {% endif %}
                    <h3 class="loja-name">{{ carro.loja.nome }}</h3>
                </div>

                <div class="loja-info-list">
                    {% if carro.loja.cidade %}
                    <div class="info-line">
                        <i data-lucide="map-pin"></i>
                        <span>{{ carro.loja.cidade.nome }} - {{ carro.loja.cidade.estado }}</span>
                    </div>
                    {% endif %}

                    {% if carro.loja.endereco %}
                    <div class="info-line">
                        <i data-lucide="map"></i>
                        <span>{{ carro.loja.endereco }}</span>
                    </div>
                    {% endif %}

                    {% if carro.loja.telefone %}
                    <div class="info-line">
                        <i data-lucide="phone"></i>
                        <a href="tel:{{ carro.loja.telefone|cut:'('|cut:')'|cut:'-'|cut:' ' }}">{{ carro.loja.telefone }}</a>
                    </div>
                    {% endif %}

                    {% if carro.loja.instagram %}
                    <div class="info-line">
                        <i data-lucide="instagram"></i>
                        <a href="{{ carro.loja.instagram }}" target="_blank">Instagram</a>
                    </div>
                    {% endif %}

                    {% if carro.loja.facebook %}
                    <div class="info-line">
                        <i data-lucide="facebook"></i>
                        <a href="{{ carro.loja.facebook }}" target="_blank">Facebook</a>
                    </div>
                    {% endif %}

                    {% if carro.loja.maps_url %}
                    <div class="info-line">
                        <i data-lucide="map"></i>
                        <a href="{{ carro.loja.maps_url }}" target="_blank">Ver no Google Maps</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- FICHA TÉCNICA -->
    <div class="ficha-section">
        <h3 class="ficha-title">Ficha Técnica</h3>

        <div class="ficha-grid">
            <div class="ficha-item">
                <span>Ano</span>
                <strong>{{ carro.ano }}</strong>
            </div>

            <div class="ficha-item">
                <span>Quilometragem</span>
                <strong>{{ carro.km }} km</strong>
            </div>

            <div class="ficha-item">
                <span>Combustível</span>
                <strong>{{ carro.get_combustivel_display }}</strong>
            </div>

            <div class="ficha-item">
                <span>Câmbio</span>
                <strong>{{ carro.get_cambio_display }}</strong>
            </div>

            <div class="ficha-item">
                <span>Portas</span>
                <strong>{{ carro.portas }}</strong>
            </div>

            <div class="ficha-item">
                <span>Cor</span>
                <strong>{{ carro.cor|default:"—" }}</strong>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    // Trocar foto principal ao clicar nas miniaturas
    const fotoPrincipal = document.getElementById("fotoPrincipal");
    const thumbs = document.querySelectorAll(".thumb");
    
    thumbs.forEach(thumb => {
        thumb.addEventListener("click", () => {
            fotoPrincipal.src = thumb.src;
            thumbs.forEach(t => t.classList.remove("active"));
            thumb.classList.add("active");
        });
    });

    // Favoritos
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.split('=')[1]);
                }
            });
        }
        return cookieValue;
    }

    const btn = document.getElementById("btnFavorito");
    if (btn) {
        const img = document.getElementById("imgFavorito");
        const csrftoken = getCookie('csrftoken');
        const carroId = btn.dataset.id;

        btn.addEventListener("click", () => {
            fetch(`/favoritar/${carroId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest",
                }
            })
                .then(r => r.json())
                .then(data => {
                    img.src = data.favoritado
                        ? "{% static 'img/heart.svg' %}"
                        : "{% static 'img/heart-outline.svg' %}";
                });
        });
    }

    // Inicializar ícones
    lucide.createIcons();
</script>

{% endblock %}
